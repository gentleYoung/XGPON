华为技术有限公司

研究管理部文档中心	产品版本	密级
	GPON	内部公开
	产品名称：GPON	共18页

GPON中QOS的处理与实现
(仅供内部使用)






拟制:	康静		日期：	2006-1-19
审核:			日期：	2006-1-19
审核:			日期：	2006-1-19
批准:			日期：	2006-1-19






华为技术有限公司
版权所有  侵权必究


修订记录
日期	修订版本	描述	作者
2006-1-19	1.00	初稿完成	康静
2006-2-7	2.00	内部检视后修改完毕	康静
2006-3-3	3.00	专家检视后修改完毕	康静
			
			
			
			
			
			
			
			
 
目  录
概述	5
1	GPON的基本结构	5
2	GPON系统中QOS的实现	7
2.1 流分类	7
2.2 访问速度（CAR）	9
2.3 队列调度	10
2.4 利用T－CONT动态带宽分配	11
2.4.1 GPON中DBA技术概述	11
2.4.2 通常动态带宽分配方法	12
2.4.3 动态带宽分配实现方法	12
3 GPON中QOS的处理流程	14
3.1 下行方向	14
3.2 上行方向	15
4 GPON中QOS测试方法说明	17
4.1 流分类测试	17
4.2 CAR测试	17
4.3 队列调度测试	18
4.4 动带带宽分配测试	18
5 总结	18

 
GPON中QOS的处理与实现
关键词： GPON、QOS、流分类、CAR 、队列调度、T-CONT
摘    要：本文对GPON系统对QOS功能的处理和实现进行了描述。
缩略语清单： 			
Abbreviations缩略语	Full spelling 英文全名	Chinese explanation 中文解释
PON	Passive Optical Network	无源光网络
GPON	Gbit Passive Optical Network	Gbit无源光网络
FTTH	Fiber To The Home	光纤到户
FTTO	Fiber To The Office	光纤到办公室
OLT	Optical Line Termination	光线路终端
ONT	Optical Network Termination	光网络终端
DBA	Dynamic Bandwidth Allocation	动态带宽调整
SBA	Static Bandwidth Allocation	静态带宽调整
SDH	Synchronous Digital Hierarchy 	同步数字系列
CAR	Committed Access Rate	允许访问速率
QOS	Quality of Service	服务质量
IGMP	Internet Group Management Protocol	因特网组管理协议
GEM	G-PON Encapsulation Method	GPON封装方法
TDM	Time Division Multiple Access	时分复用
PQ	Priority Queue	优先级队列
WRR	Weight Round Robin	加权轮循
CoS	Class of Service	服务类型
TOS	Type of Service	服务类型
VLAN	Virtual Local Area Network	虚拟局域网
		
		
		
		

 
 概述
GPON产品提供包括OLT局端设备和ONT终端设备，通过GPON接入，可以在一根光纤上同时提供VoIP Voice over IP，IP语音）电话，Internet接入，VOD, IPTV业务，CATV业务、E1专线业务。VoIP（等实时业务，这就对报文的传输延迟提出了较高要求，如果报文传送延时太长，用户是不能接受的（相对而言，E-Mail和FTP业务对时间延迟并不敏感）。为了支持具有不同服务需求的语音、视频以及数据等业务，要求GPON系统能够区分出不同的通信进而为之提供相应的服务。GPON系统使用QOS（Quality of Service，服务质量）技术解决这个问题。下面就对GPON系统的QOS技术做一个简单的介绍。
1	 GPON的基本结构
GPON系统的基本结构如下图所示，其中终端ONU/ONT放在用户家里或者楼道，提供POS口，FE口，RF口或者E1口。其中POTS电话是通过VoIP传送，实现低费用电话业务。FE接口可以独立作为PC上网接入和STB视频接入，满足客户全方位的业务体验需求。E1接口满足TDM业务的需求，用GPON系统实现对TDM业务的透明传输。OLT放在局方，GPON机框里可以插入几块OLT板，每个OLT业务板提供两个PON口，每个PON口下支持1：64分光比，就是说一个PON口下可以接入64个ONU同时注册。GPON系统的基本结构如下图所示：

 
图1 GPON系统基本结构

在OLT和ONU之间可以传输ATM或者GEM帧，目前我系统只支持GEM。GEM帧格式如下图所示。在GEM帧里可以封装以太网报文和TDM报文。GPON系统可以同时提供基于以太网的传输功能和基于TDM的传输功能。TDM专线业务主要是继承原有的DDN网络，提供数据和语音业务，在GPON系统中只是对其进行透明的传输。但是在本文中，我们只讨论以太网业务的QOS处理流程。

 
图2 下行GEM帧结构
 
图3 上行GEM帧结构
以太网报文承载在GEM上，ONU把上行以太网报文封装成GEM帧，所有的ONU按照分配的时隙向OLT发送报文。此时OLT必须对ONU进行控制和同步，以免上行报文发生碰撞。OLT接受到GEM帧后，把它恢复成以太网报文后继续向上行发送。下行方向，OLT把以太网报文封装成GEM帧后以广播的方式发送给所有的ONU，ONU根据GEM帧头的标记(port-id)过滤出自己的报文，恢复成以太网报文下发给用户。不属于自己的报文则丢弃。
GPON系统中QOS是在OLT的LSW芯片和TM芯片和ONU/T的GMAC芯片上实现。OLT的模块图如下所示，其中LSW芯片通过机框背板和主控板通信，提供4GE带宽；一个TM芯片对应一个业务板上面的PON口，每个TM和LSW之间通信带宽是3GE。GPON MAC芯片(GMAC)就是把以太网报文封装成GEM报文的GPON芯片。在下行方向，报文到GMAC芯片后，封装成GEM帧，然后以广播的方式发到这个PON口下所有ONU上。上行方向，GEM帧到GMAC芯片后被剥离成以太网报文，然后接着向上行发送。
 
图4 OLT内部芯片结构
ONU的模块图如下所示。从OLT广播的下行报文为GEM封装，到ONU的GMAC芯片后首先判断该报文是否为发给这个ONU的（通过对比GEM中PORT-ID和自己的PORT-ID进行判断）。如果是则剥离成普通的以太网报文，下行到LSW芯片进行转发，如果不是就丢弃。上行以太网报文通过LSW芯片到GMAC芯片后，被封装成GEM帧，然后按照OLT给ONU分配的时隙上行发送。
 
图5 ONU内部芯片结构
2	 GPON系统中QOS的实现
在上述的报文上下行转发过程中，GPON系统中采用两种机制实现QOS。一种是使用以太网中QOS一样的技术，比如流分类，访问速度（CAR），队列调度等等。另外一种就是GPON特有的带宽分配技术。带宽管理对于GPON中的QOS起着至关重要的作用。根据不同的CoS/T-CONT映射方式，GPON中的带宽管理分成下面三种：静态带宽分配（SBA），DBA (Dynamic Bandwidth Allocation) as per CoS, and DBA as per ONT。下面就对GPON中QOS实现涉及到的技术做一个概要的介绍。
2.1 流分类
为了识别不同的业务，以便进行不同的处理，进入系统的流首先要被区分和归类，它是其它流量管理措施的前提和基础。网络管理者可以设置报文分类的策略，这个策略可以包括物理接口、源地址、目的地址、MAC地址、IP协议或应用程序的端口号等。一般的分类算法都局限在IP报文的头部，链路层（Layer 2）、网络层（layer 3）、甚至传输层（layer 4）。在GPON系统中，上下行传送报文的时候，在OLT和ONU处都基于802.1p或者IP TOS的优先级进行了流分类。
802.1P是在链路层定义的报文优先级，即CoS（Class of Service），使用了VLAN Tag里面的三个比特（在以太网的位置如下图所示），它由IEEE802.1p文档定义。Priory字段就是802.1p优先级，它由3个bit组成，取值范围为0～7，这3位指明以太网帧优先级。优先级的顺序是0最低，7最高。一共有8种优先级，主要用于当设备端口阻塞时，优先发送哪个数据包。因为在802.1p中规定了定义的，因此也称此优先级为802.1p优先级，也简称为COS优先级。
 
图6 COS优先级
ToS（Type of Service）是IP头里面的报文分类（不直接指明优先级，而是指明报文分类，由设备决定哪些类别优先级比较高）， IP报文中的8位服务类型（TO S）字段包括一个3 bit的优先权子字段，4 bit的TOS子字段和1 bit未用位（但是必须置0）。在IP报文中的位置如下图所示。
 
图7 TOS优先级
在GPON系统中，OLT和ONU都对流量进行了分类，可以选择采用COS还是TOS进行流分类。下行方向，首先报文在进入OLT时候，在OLT的LSW芯片对报文进行了分类，报文进入ONU后在ONT的GMAC芯片又一次对报文进行分类。上行方向，首先报文进入ONU后，在GMAC芯片进行流分类。报文进入OLT后在TM芯片再次进行了流分类。流分类在GPON系统中实现的位置如下图所示：
 
图8 OLT上流分类
 
图9 ONU上流分类
2.2 访问速度（CAR）
所谓CAR就是指网络管理者可以使用约定访问速度（以后简称CAR）来对流量进行控制。CAR的具体处理过程如下图所示，首先报文被分类，如果报文是某类报文，规定了流量特性，则进入令牌桶中进行处理。如果令牌桶中有足够的令牌可以用来发送报文，则报文可以通过，可以被继续发送下去。如果令牌桶中没有令牌了，则报文被丢弃。这样，就可以对某类报文的流量进行控制。
 
图10 CAR原理图
令牌桶按用户设定的速度向桶中放置令牌，并且，令牌桶有用户设定的容量，当桶中令牌的量超出桶的容量的时候，令牌的量不再增加。当报文被令牌桶处理的时候，如果令牌桶中有足够的令牌可以用来发送报文，则报文可以通过，可以被继续发送下去，同时，令牌桶中的令牌量按报文的长度做相应的减少。当令牌桶中的令牌少到报文不能再发送时，报文被丢弃。   
在GPON系统中，OLT和ONU都对送入网络中的流量都进行了控制。下行方向，在OLT的LSW芯片中对流进行分类，在TM芯片根据分类的流，基于PORT-ID对流量进行控制。上行方向，在ONU的GMAC芯片同样基于PORT-ID对流量进行控制。由此我们可以看到，CAR被定义在OLT和ONU的入口，限制报文流入系统的流量。
2.3 队列调度
报文进入GPON一个接口没有发生拥塞的时候，报文在到达接口后立即就被发送出去，在报文到达的速度超过接口发送报文的速度时，接口就发生了拥塞。GPON系统的队列调度对不同优先级的报文进行分别处理，优先级高的报文会得到优先处理。GPON芯片调度机制有两种，PQ调度、WRR调度。
PQ：严格优先级模式，严格按照优先级从高到低的次序优先发送较高优先级队列中的分组，当较高优先级队列为空时，再发送较低优先级队列中的分组。PQ的缺点是：拥塞发生时，如果较高优先级队列中长时间有分组存在，那么低优先级队列中的报文就会由于得不到服务而“饿死”。
WRR：加权轮询调度模式，为每个队列配置一个加权值（由高到低依次为w7、w6、w5、w4、w3、w2、w1、w0），加权值表示获取资源的比重，这样可以保证最低优先级队列至少获得一定的带宽，避免了采用PQ调度时低优先级队列中的报文可能长时间得不到服务的缺点。WRR队列调度模式还有一个优点是，虽然多个队列的调度是轮循进行的，但对每个队列不是固定地分配服务时间片——如果某个队列为空，那么马上换到下一个队列调度，这样带宽资源可以得到充分的利用。
在GPON系统中，对于Pon端口上下行分别有6个WRR优先级队列和2个PQ队列，PQ队列是绝对优先级队列，固定为队列0和队列1，而6个WRR是根据权重进行调度的，系统支持针对Pon端口的上下行方向，分别配置WRR队列的权重。权重是按照比例来配置的，每次必须6个队列的权重都重新配置，且权重和为100。默认情况下，6个WRR队列的权重分别为30、25、20、10、10、5。在GPON系统中，下行方向在OLT的TM芯片进行PQ+WRR调度，在ONU的GMAC芯片进行PQ调度。上行方向，在ONU的GMAC芯片进行PQ+WRR调度，在OLT的TM芯片进行PQ+WRR调度，在OLT的LSW芯片进行PQ调度。之所以采用PQ+WRR的调度方式时因为可以保证最高优先级业务的带宽，也避免在流量较大的情况下最低优先级业务被完全丢弃。GPON系统中队列调度的实现点如下图所示：
 
图11 OLT中的队列调度

 
图12 ONU上的队列调度

2.4 利用T－CONT动态带宽分配
2.4.1 GPON中DBA技术概述
在GPON系统中带宽分配主要有静态带宽分配和动态带宽分配两种方式。静态分配带宽是一种最简单的带宽分配方式。但是，IP业务连接许多突发业务源，所以这类业务是非恒定比特率业务，对信元传输和信元延时变化的要求并不严格。然而，映射这些非实时业务到固定带宽信道中，不能使PON中的ONU动态地分享PON的上行带宽。这种静态授权方式使上行带宽使用效率不高，所以希望使用动态带宽分配技术。
动态带宽分配（DBA）方式根据ONU突发业务量的需求，动态地调整他们的上行接入带宽，因此提高了PON上行带宽的使用效率。首先，由于更有效的使用带宽，网络操作者可以增加更多的用户到PON上。其次，用户可以要求得到超过固定带宽分配的最大带宽，享受更好的服务。
2.4.2 通常动态带宽分配方法
实现DBA有两种方法，一种是空闲信元调整，另一种是缓冲器使用情况报告。在空闲信元调整方式中，OLT检视每个ONU使用的带宽，假如一个ONU使用的带宽超过了预先分配的值，如果还有富余的带宽可以使用，OLT就分配额外的带宽给该ONU。这种方法不需要ONU报告带宽需求信息，其缺点是OLT的反应总是落后于ONU对带宽的需求。在缓冲器使用情况报告方式中，ONU向OLT报告它们的缓冲器被使用的状态，OLT根据该报告重新分配ONU下次可以使用的带宽。
2.4.3 动态带宽分配实现方法
使系统具有动态带宽分配功能，可以分两步实现。首先，把具有DBA能力的OLT装入以前不具有DBA能力的系统。因为系统不具有DBA能力，所以它不向OLT报告ONU的缓冲器使用情况，称这种ONU非带宽需求报告ONU（NSR-ONU）。此时，OLT使用空闲信元调整方法实现DBA。其次，装入具有带宽需求报告能力的ONU（SR-ONU）,此时OLT可以使用缓冲器使用情况报告分配带宽给ONU。另外，DBA也可以混合使用非带宽需求报告ONU和带宽需求报告ONU。目前，我产品的ONU是SR-ONU，但是与其他厂商对接的时候会遇到NSR-ONU。
GPON DBA功能需要在每个T-CONT连接中实现。一个T-CONT对应一种带宽业务流，这种业务流有自己的QOS特征。QOS特征主要体现在带宽保证上，分为固定带宽，保证带宽，保证/不保证带宽，尽力转发，混合方式五种。
固定带宽：是一种周期性分配完全预约的带宽，使用它可以实现小的信元传输延迟。假如T-CONT预约了固定带宽，但它又没有信元发送，OLT仍然发送使用固定带宽的授权给T-CONT，此时ONU就发送空闲信元给OLT。
保证带宽：是假如T-CONT缓冲器想发送信元时，ONU总是可以使用的带宽。假如T-CONT缓冲器没有信元发送，该带宽可以被其他T-CONT使用。所以确保带宽能够参与动态分配。
不保证带宽：是分配给具有确保带宽的T-CONT地额外带宽，在额外带宽中它具有较高的优先级别。非确保带宽能够参与动态带宽分配。
尽力转发：是指当没有高优先权业务使用该带宽时，T-CONT可以使用的带宽，所以它是不能确保使用的带宽，只能参与动态带宽分配，只有DBA-OLT支持。
T-CONT主要是从带宽的保证角度而不是从业务的种类（如CBR，UBR等，这里包含了带宽、延时、抖动等等的考虑），来划分的。因此T-CONT分成5种类型，每种类型有其典型的应用，支持不同级别的带宽分配。5种T-CONT和5种带宽类型的关系如下图所示：
 
由上面的表可见，动态分配带宽只对额外带宽进行分配。按T-CONT的保证带宽比例，从剩余带宽中分配非保证带宽给要求额外带宽的每个T-CONT。如果保证带宽是0，则要公平地分配非保证带宽和尽力转发带宽给每个T-CONT。在带宽分配中，首先分配固定带宽，包括时隙位置，以便减少延迟和延迟变化；然后，分配确保带宽；最后把仍然没有被预约的带宽放到剩余带宽库中，作为非确保带宽和尽力而为带宽。
单个T-CONT可以携带不用种类的业务流量，并且把它们的缓冲器使用情况报告给与此相连的OLT。一个ONU可以只有一个T-CONT,也可以有多个T-CONT。我公司ONU最多支持8个T-CONT，每个可以相互独立工作，每个T-CONT用唯一的ALLOC ID进行标识。每个T-CONT向OLT发送DBRu报告，报告目前缓冲器使用状况，而OLT根据DBRu报告给每个T-CONT分配带宽。不同T-CONT间发送DBRu报告，OLT分配带宽示意图如下所示：
 
图13 DBRu报告原理图

 
图14 带宽分配原理图



3 GPON中QOS的处理流程
3.1 下行方向
OLT侧处理流程（LSW、TM模块实现）：
1)	下行报文基于802.1p或者IP TOS进行流分类。
2)	基于Port-ID进行CAR，可设置平均带宽和突发度，其中突发度支持双个门限，门限值可设置。
3)	每个GPON接口支持8个队列，队列按照802.1p或者IP TOS进行优先级映射。最高的两个优先级队列采用PQ调度方式，其余6个队列采用WRR调度方式，权值可设置。PQ+WRR的调度方式即可以保证最高优先级业务的带宽，也避免在流量较大的情况下最低优先级业务被完全丢弃。
4)	队列拥塞时采用尾丢弃方式。
ONU/ONT侧处理流程（GPON MAC模块实现）：
1)	下行报文基于802.1p或者IP TOS的优先级进行流分类。
2)	支持8个队列，队列按照802.1p或者IP TOS进行优先级映射，采用PQ的调度方式。
3)	队列拥塞时采用尾丢弃方式。
下行方向QOS处理流程示意图如下：
 
图15 OLT下行方向QOS处理流程

 
图16 ONU下行方向QOS处理流程
3.2 上行方向
ONU/ONT侧处理流程（GPON MAC模块实现）：
1)	上行报文基于Port-ID进行CAR，可设置平均带宽和突发度，其中突发度支持双门限，门限值可设置。
2)	基于802.1p或者IP TOS的优先级进行流分类。
3)	每个T-CONT内部支持4个队列，队列按照802.1p或者IP TOS进行优先级映射，采用PQ或者WRR调度方式，WRR方式下权值可设置。
4)	队列拥塞时采用尾丢弃方式。
5)	T-CONT之间采用DBA（动态带宽分配）或者SBA（静态带宽分配）方式进行带宽申请。
OLT侧处理流程（LSW、TM模块实现）：
1)	上行报文基于802.1p或者IP TOS的优先级进行流分类。
2)	每个GPON接口支持8个队列，队列按照802.1p或者IP TOS进行优先级映射，最高的两个优先级队列采用PQ调度方式，其余6个队列采用WRR调度方式，权值可设置。
3)	队列拥塞时采用尾丢弃方式。
4)	两个GPON接口的上行报文在LSW汇聚后，在出口支持8个队列调度，队列按照802.1p或者IP TOS进行优先级映射，采用PQ调度方式。队列拥塞时采用尾丢弃方式。
上行方向QOS处理流程示意图如下：
 
图17 ONU上行方向QOS处理流程

 
图18 OLT上行方向QOS处理流程
4 GPON中QOS测试方法说明
4.1 流分类测试
描述：该项目测试的是对原先带有优先级标志的报文进行分类的情况。
关键点：在QoS的处理过程中，可以承认用户携带的优先级，也可以重新定义优先级，目前产品是可以选择的。本项目需要观察的是对于承认用户携带优先级时候，是否能够把不同优先级的报文映射到不同队列里，然后进行不同的处理。在对带有优先级标志的报文进行重新定义时，主要观察报文是否按照重定义的优先级映射到不同的队列里。
测试方法：通过测试仪构造带各种优先级的报文进行测试，通过调整发送流量，在上行抓包观察8个优先级报文是否正确。
4.2 CAR测试
描述：所谓CAR就是指网络管理者可以使用约定访问速度（以后简称CAR）来对流量进行控制。
关键点：CAR测试中需要关注基本速率和突发速率。基本速率就是指在一段时间内允许通过的报文的速率，也就是实现对报文流量的限制，这在实际应用中很重要。本项目主要是观察对于不同的基本速率，QoS所实现的速率限制的精确度是否达到要求。突发速率是在短暂时间内可以允许速率超过限定的基本速率。
测试方法：在系统中可以选择不同的CAR模板，使用测试仪上下行发包，不断变化流量，看流量是否按照不同CAR模板设定在一个范围内。另外还可以使用测试仪发送突发流量，看系统突发流量是否达到CAR里面的设定值。
4.3 队列调度测试
描述：该项目测试的是QoS的拥塞管理对流进行出端口带宽比例分配的情况。我系统支持PQ调度和WRR调度，对WRR调度中可以配置6个队列的权重。在实现时，最高优先级的两个队列采用PQ调度，后面6个优先级的队列采用WRR加权调度。
关键点：本项目主要是观察QoS对流的调度策略和权重的实现是否正确。
测试方法：通过测试测试仪分别构造匹配不同优先级的报文，所有报文从一个端口转发，总流量超过端口总带宽。在系统出口抓包，观察是否最高优先级按照PQ调度，后面六个优先级符合权重配置。
4.4 动态带宽分配测试
描述：该项目测试的是GPON系统中配置了不同带宽模板的PORT-ID分配的带宽大小。
关键点：本项目重点观察多个PORT-ID同时转发报文，是否按照DBA调度方法正确分配带宽。
测试方法：通过测试测试仪分别构造匹配不同VLAN的报文，承载在不同PORT-ID上，每个PORT-ID使用不同的带宽模板，测试每个PORT-ID抓法流量，观察是否符合GON系统DBA分配方法获得带宽。
5 总结
本文讨论了GPON系统中以太网业务的QOS相关技术。GPON系统中采用两种机制实现QOS。一种是使用以太网中QOS一样的技术，比如流分类，访问速度（CAR），队列调度等等。另外一种就是GPON特有的带宽分配技术，利用T-CONT实现DBA（GPON中DBA技术详细实现方法请参考其他相关文档）。本文最后给出上述四种QOS技术的测试方法，可供测试人员学习GPON中QOS技术和特进行QOS特性测试时参考。
